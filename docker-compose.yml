db:
  image: mysql
  volumes:
    - "./data/piwik/db:/var/lib/mysql"
  environment:
    MYSQL_ROOT_PASSWORD: malakas
app:
  image: piwik
  links:
    - db
  volumes:
    - "./data/piwik/config:/var/www/html/config"
    - ./ssmtp.conf:/etc/ssmtp/ssmtp.conf
    - ./revaliases:/etc/ssmtp/revaliases
web:
  image: nginx
  volumes:
    - ./nginx.conf:/etc/nginx/nginx.conf:ro
  links:
    - app
  ports:
    - "8001:80"
  volumes_from:
    - app
  environment:
    - VIRTUAL_HOST
cron:
  image: piwik
  links:
    - db
  volumes_from:
    - app
  entrypoint: |
    bash -c 'bash -s <<EOF
    trap "break;exit" SIGHUP SIGINT SIGTERM
    while /bin/true; do
      su -s "/bin/bash" -c "/usr/local/bin/php /var/www/html/console core:archive" www-data
      sleep 3600
    done
    EOF'

db2:
  image: mysql:5.7
  volumes:
    - "./data/wordpress/db:/var/lib/mysql"
  restart: always
  environment:
    MYSQL_ROOT_PASSWORD: wordpress
    MYSQL_DATABASE: wordpress
    MYSQL_USER: wordpress
    MYSQL_PASSWORD: wordpress

wordpress:
  image: wordpress:latest
  volumes:
    - "./data/wordpress/www:/var/www/html"
  links:
    - db2
    - web
  ports:
    - "8000:80"
  restart: always
  environment:
    WORDPRESS_DB_HOST: db2:3306
    WORDPRESS_DB_PASSWORD: wordpress
